.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        Click :ref:`here <sphx_glr_download_auto_examples_plot_afq_api.py>`     to download the full example code
    .. rst-class:: sphx-glr-example-title

    .. _sphx_glr_auto_examples_plot_afq_api.py:


==========================
AFQ API
==========================

An example using the AFQ API




.. code-block:: default

    import os.path as op

    import matplotlib.pyplot as plt
    import nibabel as nib
    import plotly

    from AFQ import api
    import AFQ.data as afd








Get some example data
---------------------

Retrieves High angular resolution diffusion imaging (HARDI) dataset from
Stanford's Vista Lab

  see https://purl.stanford.edu/ng782rw8378 for details on dataset.

The data for the first subject and first session are downloaded locally
(by default into the users home directory) under:

  ``.dipy/stanford_hardi/``

Anatomical data (``anat``) and Diffusion-weighted imaging data (``dwi``) are
then extracted, formatted to be BIDS compliant, and placed in the AFQ
data directory (by default in the users home directory) under:

  ``AFQ_data/stanford_hardi/``

This data represents the required preprocessed diffusion data necessary for
intializing the AFQ object (which we will do next)


.. code-block:: default


    afd.organize_stanford_data()








Initialize an AFQ object:
-------------------------

Creates an AFQ object, that encapsulates tractometry. This object can be
used to manage the entire AFQ pipeline, including:

- Tractography
- Registration
- Segmentation
- Cleaning
- Profiling
- Visualization

In this example we will load the subjects session data from the previous step
using the default AFQ parameters.

.. note::

   The first time intializing the AFQ object will download necessary
   waypoint regions of interest (ROIs) templates into AFQ data directory:

- Human corpus callosum templates: ``AFQ_data/callosum_templates/``

  see https://digital.lib.washington.edu/researchworks/handle/1773/34926

- Tract probability maps: ``AFQ_data/templates/``

  see https://figshare.com/articles/Tract_probability_maps_for_automated_fiber_quantification/6270434

These waypoints ROIs will used to identify the desired white matter tracts.

This will also create an output folder for the corresponding AFQ derivatives
in the AFQ data directory: ``AFQ_data/stanford_hardi/derivatives/afq/``

To initialize this object we will pass in the path location to our BIDS
compliant data.

.. note::

   As noted above, the Stanford HARDI data contains anatomical and
   diffusion weighted imaging (dwi) data. In this example, we are interested
   in the vistasoft dwi. For our dataset the `dmriprep` is optional, but
   we have included it to make the initialization more explicit.

.. note::

   We will also be using plotly to generate an interactive visualization.
   So we will specify plotly_no_gif as the visualization backend.


.. code-block:: default


    myafq = api.AFQ(bids_path=op.join(afd.afq_home,
                                      'stanford_hardi'),
                    dmriprep='vistasoft',
                    viz_backend='plotly_no_gif')





.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Downloading https://templateflow.s3.amazonaws.com/tpl-MNI152NLin2009cAsym/tpl-MNI152NLin2009cAsym_res-01_T1w.nii.gz
      0%|          | 0.00/13.4k [00:00<?, ?B/s]     45%|####5     | 6.08k/13.4k [00:00<00:00, 60.8kB/s]     98%|#########8| 13.1k/13.4k [00:00<00:00, 63.4kB/s]    13.4kB [00:00, 65.1kB/s]                            
    Downloading https://templateflow.s3.amazonaws.com/tpl-MNI152NLin2009cAsym/tpl-MNI152NLin2009cAsym_res-01_desc-brain_mask.nii.gz
      0%|          | 0.00/155 [00:00<?, ?B/s]    156B [00:00, 6.69kB/s]                   
    /opt/hostedtoolcache/Python/3.6.12/x64/lib/python3.6/site-packages/bids/layout/models.py:102: FutureWarning:

    The 'extension' entity currently excludes the leading dot ('.'). As of version 0.14.0, it will include the leading dot. To suppress this warning and include the leading dot, use `bids.config.set_option('extension_initial_dot', True)`.





Reading in DTI FA (Diffusion Tensor Imaging Fractional Anisotropy)
------------------------------------------------------------------
The AFQ object holds a table with file names to various data derivatives.

For example, the file where the FA computed from DTI is stored can be
retrieved by inspecting the ``dti_fa`` property. The measures are stored
in a series, and since we only have one subject and one session we will
access the first (and only) file name from the example data.

.. note::

   The AFQ API computes quantities lazily. This means that DTI parameters
   are not computed until they are required. This means that the first
   line below is the one that requires time.

We will then use `nibabel` to load the deriviative file and retrieve the
data array.


.. code-block:: default


    FA_fname = myafq.dti_fa[0]
    FA_img = nib.load(FA_fname)
    FA = FA_img.get_fdata()








Visualize the result with Matplotlib
-------------------------------------
At this point `FA` is an array, and we can use standard Python tools to
visualize it or perform additional computations with it.

In this case we are going to take an axial slice halfway through the
FA data array and plot using a sequential color map.

.. note::

   The data array is structured as a xyz coordinate system.


.. code-block:: default


    fig, ax = plt.subplots(1)
    ax.matshow(FA[:, :, FA.shape[-1] // 2], cmap='viridis')
    ax.axis("off")




.. image:: /auto_examples/images/sphx_glr_plot_afq_api_001.png
    :alt: plot afq api
    :class: sphx-glr-single-img


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none


    (-0.5, 105.5, 80.5, -0.5)



Visualizing bundles and tract profiles:
---------------------------------------
The pyAFQ API provides several ways to visualize bundles and profiles.

First, we will run a function that exports an html file that contains
an interactive visualization of the bundles that are segmented.

.. note::
   By default we resample a 100 points within a bundle, however to reduce
   processing time we will only resample 50 points.

Once it is done running, it should pop a browser window open and let you
interact with the bundles.

.. note::
   Running the code below triggers the full pipeline of operations
   leading to the computation of the tract profiles. Therefore, it
   takes a little while to run (about 40 minutes, typically).

.. note::
   You can hide or show a bundle by clicking the legend, or select a
   single bundle by double clicking the legend. The interactive
   visualization will also all you to pan, zoom, and rotate.


.. code-block:: default


    bundle_html = myafq.viz_bundles(export=True, n_points=50)
    plotly.io.show(bundle_html[0])




.. raw:: html
    :file: images/sphx_glr_plot_afq_api_002.html


.. rst-class:: sphx-glr-script-out

 Out:

 .. code-block:: none

    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]
    Optimizing level 2 [max iter: 10000]
    Optimizing level 1 [max iter: 1000]
    Optimizing level 0 [max iter: 100]




We can also visualize the tract profiles in all of the bundles. These
plots show both FA (left) and MD (right) layed out anatomically.



.. code-block:: default


    myafq.plot_tract_profiles()
    fig_files = myafq.data_frame['tract_profiles_viz'][0]








.. figure:: {{ fig_files[0] }}



.. rst-class:: sphx-glr-timing

   **Total running time of the script:** ( 28 minutes  47.961 seconds)


.. _sphx_glr_download_auto_examples_plot_afq_api.py:


.. only :: html

 .. container:: sphx-glr-footer
    :class: sphx-glr-footer-example



  .. container:: sphx-glr-download sphx-glr-download-python

     :download:`Download Python source code: plot_afq_api.py <plot_afq_api.py>`



  .. container:: sphx-glr-download sphx-glr-download-jupyter

     :download:`Download Jupyter notebook: plot_afq_api.ipynb <plot_afq_api.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
